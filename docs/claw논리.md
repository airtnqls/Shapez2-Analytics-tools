## 1단계: 초기 설정 및 정보 수집

프로세스 시작 전, 원본 도형을 분석하여 변형에 필요한 핵심 정보를 미리 확보하고 준비합니다.

- **정보 추출**

  - '원본 도형'을 분석하여 다음의 핵심 정보를 변수에 저장합니다.
    - **pins**: 1층(가장 아래층, layer 0)에 위치한 모든 P(핀) 조각의 사분면 번호(0~3).
    - **highest_c_layer**, **c_quad_idx**: 도형 전체에서 가장 높은 층에 있는 단일 c(크리스탈)의 층 번호와 사분면 번호. 이 c는 여러 규칙에서 기준점 역할을 합니다.
- **'외곽선 c' 제거 좌표 수집**

  - 최종 단계에서 제거할 크리스탈의 위치를 미리 정의합니다.
    - **기준**: 원본 도형에 있는 모든 c(크리스탈) 조각의 위치를 찾습니다.
    - **규칙**: 찾은 각 c 조각의 물리적으로 인접한 상, 하, 좌, 우 위치를 모두 '제거 대상 좌표' 목록에 추가합니다.
    - **예외**: 목록 수집이 완료된 후, '원본 c' 조각 자체의 위치는 이 '제거 대상' 목록에서 제외됩니다. 이는 원본 c는 보존하면서 그 주변부만 정리하는 효과를 낳습니다.

---

## 2단계: S(일반 도형) 조각 재배치

특정 패턴을 만족하는 S 조각들을 우선순위에 따라 그룹으로 묶어, 유효한 위치로 이동시킵니다.

### 2-1. 'PS--c' 패턴 변환 (최우선)

- **탐색 대상**: 특정 기둥(사분면)이 1층부터 'P', 'S', '-', '-', 'c' 순서로 쌓여있는 패턴을 찾습니다.
- **변환 조건** (아래 조건을 **모두** 만족해야 함):
  1. 패턴의 5층 'c' 조각이 `highest_c_layer`에 위치해야 합니다.
  2. `highest_c_layer` (가장 높은 c의 층)에 빈 공간이 정확히 2개여야 합니다.
  3. `highest_c_layer` 바로 아래층의 같은 사분면은 비어있어야 하며, 그 빈 공간의 양 옆에 c나 S 조각이 없어야 합니다.
  4. 패턴의 S(2층 위치) 양 옆과 그 바로 위(3층 위치)에 c 조각이 없어야 합니다.
- **실행**: 위 조건을 모두 만족하면, 2층에 있던 S 조각을 4층의 같은 사분면 위치로 이동시킵니다. ('PS--c' -> 'P--Sc')

### 2-2. '두 번 뜬 S' 그룹 이동

- **탐색 대상**: 3층에 S가 있고, 그 바로 아래인 2층과 바로 위인 4층이 모두 비어있는 기둥을 찾습니다.
- **그룹화 규칙** (`_find_twice_floating_s_group`)
  - 탐색 대상이 된 3층의 S에서 그룹 만들기를 시작합니다. 탐색은 시작점과 같은 층의 양 옆으로만 제한됩니다.
  - **그룹 확장 조건 1**: 현재 그룹에 속한 S와 같은 층에 인접한 다른 S가 있고, 그 다른 S의 바로 위 칸이 비어있다면 그 다른 S도 그룹에 포함시킵니다.
  - **그룹 확장 조건 2 (특별 규칙)**: 시작점 S의 아래에 있는 S(2층)도 그룹에 포함될 수 있습니다. (단, 그 아래(1층)에 P가 있다면 포함되지 않습니다.)
- **이동 규칙**
  - **이동 전제 조건 (취소 조건)**: 다음 중 하나라도 해당되면 그룹을 이동시키지 않습니다.
    1. 그룹에 속하지 않은 인접 S의 바로 아래가 비어있는 경우. (불안정한 구조 방지)
    2. 그룹의 모든 조각들 바로 아래가 이미 비어있는 경우. (불필요한 이동 방지)
    3. 시작점 S의 아래(1층) 양 옆이 비어있고, 그 아래(0층)가 S가 아닐 경우.
    4. 시작점 S의 아래(0층)가 비어있으면서, 아래 세부 조건 중 하나라도 참일 경우:
       - (B) 그룹에 속하지 않은 3층의 다른 사분면에 S나 c가 있을 때.
       - (C) `highest_c_layer`에 빈 공간이 1개 이하일 때.
       - (D) 시작점 S의 사분면이 `c_quad_idx`와 다를 때.
  - **실행**: 모든 전제 조건을 통과하면, 그룹 전체를 위로 한 칸 올립니다. 단, 이동할 위치가 비어있고 아래 2-3의 '유효성' 판단 기준(인접/높이 제한)을 만족해야 합니다. 만족하지 않으면 이동하지 않습니다.

### 2-3. '뜬 S' 그룹 이동

- **탐색 대상**: 1층이 비어 있고 2층에 S가 있는 기둥을 찾습니다.
- **그룹화 규칙** (`_find_s_star_group`)
  - 탐색 대상이 된 2층의 S에서 그룹 만들기를 시작합니다.
  - **그룹 확장 조건 A**: 현재 그룹 조각과 인접한 S의 바로 위가 비어있으면 그 S를 그룹에 추가합니다.
  - **그룹 확장 조건 B**: 현재 그룹 조각과 인접한 S의 위가 다른 S나 P로 막혀있지만, 그 막고 있는 조각의 바로 위가 비어있다면, 인접 S와 그를 막고 있는 조각 둘 다 그룹에 추가합니다.
- **이동 규칙** (`_move_s_group`)
  - **최대 상승 거리 계산**: 그룹에 속한 각 기둥에서 가장 위에 있는 조각을 찾습니다. 그 조각 위로 연속된 빈 공간의 개수를 셉니다. 그룹 전체가 한 번에 올라갈 수 있는 거리는 이 개수들의 최솟값입니다.
  - **최적 위치 탐색 (하강 방식)**: 계산된 최대 상승 위치에서 시작하여, 그룹 전체를 한 층씩 아래로 내리면서 '유효성 검사'를 수행합니다.
  - **'유효성' 판단 기준** (아래 모든 조건을 만족해야 함):
    - **충돌 없음**: 그룹의 어떤 조각이라도 이동할 위치에 다른 조각(그룹 외 조각)이 없어야 합니다.
    - **인접 규칙**: 그룹 내 S 조각이 이동한 위치의 양 옆에, 그룹에 속하지 않은 S나 c 조각이 하나라도 있으면 안 됩니다.
    - **높이 제한 규칙**: `highest_c_layer`(가장 높은 c의 층)의 정반대편 사분면에 있는 가장 높은 조각의 높이가 (`highest_c_layer` - 1)보다 높거나 같으면 안 됩니다.
  - **실행**: 최초로 '유효성' 검사를 통과하는 위치가 최종 목적지가 됩니다. 원본 위치의 그룹 조각들을 모두 지우고, 계산된 새 위치에 배치합니다. 만약 유효한 위치를 찾지 못하면 이동하지 않습니다.
  - **후처리**: 이동한 그룹이 단일 S 조각이고, 이동 후 양 옆에 P가 위치하게 되면, 해당 P들을 위로 한 칸 올립니다 (단, 올릴 공간이 비어있어야 함).

### 2-4. '바닥 S + 블로커' 그룹 이동

- **탐색 대상**: 1층에 S가 있고, 그 바로 위인 2층에 P(핀) 또는 S가 있는 기둥을 찾습니다.
- **그룹화 규칙**: 1층의 S와 2층의 P 또는 S를 하나의 그룹(조각 2개)으로 묶습니다.
- **이동 규칙**: 위의 '뜬 S'와 동일한 `_move_s_group` 규칙을 따릅니다.
- **후처리**: 이동 후 그룹의 S 조각의 양 옆에 P가 위치하게 되면, 해당 P들을 위로 한 칸 올립니다.

### 2-5. '개별 바닥 S' 이동

- **탐색 대상**: 위 그룹화에 포함되지 않은, 1층에 있는 모든 S 조각.
- **이동 규칙** (`_find_s_relocation_spot`)
  - 각 S에 대해 개별적으로 이동할 최적의 위치를 탐색합니다.
  - **하늘이 열려있을 경우**: 3층부터 위로 올라가며 2-3의 '유효성' 판단 기준을 만족하는 첫 위치를 찾습니다.
  - **하늘이 막혀있을 경우**:
    1. 그 기둥을 막고 있는 가장 낮은 조각(천장)의 바로 아래층부터 아래로 내려오며 유효한 위치를 찾습니다.
    2. 만약 찾지 못하면, 다시 천장 아래부터 탐색하되 이번에는 **가상 이동**을 허용합니다.
       - **가상 이동**: 유효한 공간을 만들기 위해, 인접한 S 조각을 위로 한 칸 올리는 가상 이동을 시도하고 그 결과가 유효한지 판단합니다.
  - **실행**: 찾은 첫 번째 유효한 위치에 S를 배치하고, 가상 이동이 있었다면 해당 S도 실제로 이동시킵니다.
  - **후처리**: 이동한 S 조각의 양 옆에 P가 위치하게 되면, 해당 P들을 위로 한 칸 올립니다.

---

## 3단계: P(핀)와 S(일반 도형) 들어 올리기 (반복 수행)

모든 S 그룹 이동이 끝난 후, 특정 국소 패턴을 찾아 조각을 조정하는 과정을 더 이상 움직일 조각이 없을 때까지 반복합니다.

- **실행 조건**: 이 로직은 한 번의 전체 스캔에서 조각 이동이 있었으면, 다시 처음부터 반복 실행됩니다. 이동이 없으면 종료됩니다.
- **탐색 대상**: 1층에 있는 P(핀) 중, 바로 위(2층) 칸이 비어있는 경우.
- **실행 규칙**:
  - **시나리오 1**: 위에서 찾은 2층의 빈 공간을 기준으로, 그 주변 세 방향(좌, 우, 위)이 모두 다른 조각으로 막혀 있는지 확인합니다. 만약 막혀있다면, 그 막고 있는 양옆의 조각(P 또는 S)을 들어 올립니다.
    - **P 올리기**: 위가 비어있으면 한 칸 올립니다. 연속된 P-P가 있다면 두 조각을 함께 올립니다.
    - **S 올리기**: 2-3의 '유효성' 기준을 만족하는 가장 낮은 빈 공간을 찾아 그 위치까지 올립니다.
  - **시나리오 2**: 시나리오 1에 해당하지 않고, P 위 2층 공간의 양옆은 막혀있지만 3층 공간이 비어있는 경우, 3층의 빈 공간을 기준으로 다시 주변을 검사하여 양옆 조각을 들어 올립니다.

---

## 4단계: c(크리스탈) 조각 채우기

모든 S와 P의 이동이 완료된 후, 정해진 규칙에 따라 빈 공간을 c로 채웁니다.

- **핀 위 채우기**: 1단계에서 찾은 모든 P(핀)의 위치에서 수직으로 위쪽을 보며, 연속된 모든 빈 공간을 c로 채웁니다. 다른 조각을 만나면 멈춥니다.
- **반대편 사분면 채우기 및 주변부 확장**: 1단계에서 찾은 `highest_c_layer`의 정반대편 사분면에, 맨 위층부터 아래로 c 기둥을 세웁니다.
  - **기둥 중단 조건**: 기둥을 세우다가 다른 조각을 만나거나, 또는 빈 공간이지만 그 옆에 '원본 도형'에 있던 c가 존재하면 기둥 세우기를 중단합니다.
  - **벽 생성(c')**: 기둥을 세우는 동안, 특정 조건을 만족하면 기둥 옆의 빈 공간에도 c를 채워 벽처럼 확장합니다.
    - **배치 불가 조건**: 3층에 놓을 때 2층이 비거나 c인 경우, 4층에 놓을 때 3층/2층의 조합이 (P, c/S) 또는 (-, c/-)인 경우, 원본 도형에 c가 있었던 경우, 옆옆에 c가 있는 경우는 배치하지 않습니다.
    - **P 들어올리기 예외**: 3층에 P가 있고 그 위가 비어있으면, P를 위로 한 칸 올리고 그 자리에 c'를 배치할 수 있습니다.
      - **S 내리기 후처리**: 이로 인해 이동된 P(이제 4층) 옆에 S가 있고, 그 S의 양 옆이 모두 P가 되면, S를 한 칸 아래로 내립니다.
  - **아래 채우기(c'')**: 벽으로 새로 생긴 c의 바로 아래가 비어있고, 그 위치가 3층 이상이며 원본 도형에 c가 없었다면 그 공간도 c로 메웁니다.
  - **예약 및 조건부 생성**:
    - **예약**: 벽 생성 시, 4층에 c'를 놓으려는데 3층이 비고 2층이 P인 패턴을 만나면 즉시 채우지 않고 '예약'합니다.
    - **조건부 생성**: 모든 c 채우기가 끝난 후, 예약된 위치(4층) 아래(3층)에 c''를 놓을 수 있는 조건(비어있고, 주변에 원본 c가 없음)이 충족되면, 예약된 c'(4층)와 그 아래 c''(3층)를 함께 채웁니다.

---

## 5단계: 마무리 및 최종 반환

- **'외곽선 c' 제거**: 1단계에서 수집해 둔 '제거 대상 좌표' 목록에 해당하는 위치의 c 조각들을 모두 제거합니다.
- **1층 제거**: 변형이 완료된 작업 도형에서 1층(layer 0)을 통째로 버립니다.
- **빈 층 정리**: 도형의 맨 위부터 비어있는 층이 있다면 모두 삭제합니다.
- **최종 반환**: 완성된 도형의 구조를 다시 문자열 코드로 변환하여 반환합니다.

---

---

### 논리 단위 상세 분해 (총 33개)

#### 1단계: 초기 정보 분석 (3개 로직)

* **핀 위치 수집기 (Pin Location Collector)**

  * **Input**: 원본 도형 데이터.
  * **Logic**: 1층(layer 0)을 스캔하여 모든 **P** 조각의 사분면 인덱스를 찾는다.
  * **Output**: **pins** 리스트 (e.g., `[0, 2]`).
* **최고 크리스탈 식별자 (Highest Crystal Identifier)**

  * **Input**: 원본 도형 데이터.
  * **Logic**: 모든 층을 스캔하여 가장 높은 층에 있는 **c** 조각을 찾고, 그 층 번호와 사분면 인덱스를 기록한다.
  * **Output**: **highest_c_layer**, **c_quad_idx** 변수.
* **외곽선 제거 좌표 생성기 (Outline Removal Target Generator)**

  * **Input**: 원본 도형의 모든 **c** 조각 위치.
  * **Logic**: 모든 원본 **c**의 상하좌우 좌표를 수집한 후, 그중 다른 원본 **c**의 위치와 겹치는 좌표는 목록에서 제외한다.
  * **Output**: 제거 대상 좌표 목록 (Set).

#### 2단계: S 조각 재배치 (16개 로직)

**[최우선 패턴 변환 로직 1개]**

* **'PS--c' 패턴 변환기 (PS--c Pattern Transformer)**
  * **Input**: 전체 도형, `highest_c_layer` 정보.
  * **Logic**: 1~5층이 'P, S, -, -, c' 패턴이고, 4개의 변환 조건을 모두 만족하는지 검사한다. 만족 시 2층의 S를 4층으로 이동시킨다.
  * **Output**: 변경된 도형 데이터.

**['두 번 뜬 S' 그룹 처리 로직 4개]**

* **'두 번 뜬 S' 탐색기 (Twice-Floating S Seeker)**
  * **Input**: 전체 도형 데이터.
  * **Logic**: 3층에 **S**가 있고 2층과 4층이 비어있는 기둥(시작점)을 찾는다.
  * **Output**: 그룹 형성의 시작점이 될 **S** 조각의 위치 목록.
* **'두 번 뜬 S' 그룹 빌더 (`_find_twice_floating_s_group`)**
  * **Input**: 그룹 시작점 S 위치.
  * **Logic**: 시작점에서부터 '확장 조건 1, 2'에 따라 인접한 **S**들을 탐색하여 하나의 그룹으로 묶는다.
  * **Output**: **S** 조각 위치들로 구성된 단일 그룹.
* **'두 번 뜬 S' 이동 전제 조건 검사기 (Twice-Floating S Pre-move Validator)**
  * **Input**: 생성된 '두 번 뜬 S' 그룹.
  * **Logic**: 이동을 취소시키는 4가지의 복잡한 전제 조건(불안정 구조, 불필요 이동, 아래쪽 '-' 패턴 등)을 모두 검사한다.
  * **Output**: 이동 가능 여부 (True/False).
* **'두 번 뜬 S' 이동 실행기 (Twice-Floating S Mover)**
  * **Input**: 유효성 검사를 통과한 그룹.
  * **Logic**: 그룹을 위로 한 칸 올릴 위치가 유효한지 최종 확인 후, 그룹을 실제로 한 칸 위로 이동시킨다.
  * **Output**: 변경된 도형 데이터.

**[일반 그룹 탐색 및 형성 로직 3개]**

* **'뜬 S' 탐색기 (Floating S Seeker)**
  * **Input**: 전체 도형 데이터.
  * **Logic**: 1층이 비고 2층에 **S**가 있는 기둥(시작점)을 찾는다.
  * **Output**: 그룹 형성 시작점 위치 목록.
* **'뜬 S' 그룹 빌더 (`_find_s_star_group`)**
  * **Input**: '뜬 S' 시작점.
  * **Logic**: 시작점에서부터 '확장 조건 A, B'에 따라 인접 **S**와 그 블로커(**S** 또는 **P**)까지 포함하여 그룹으로 묶는다.
  * **Output**: **S**, **P** 조각 위치들로 구성된 단일 그룹.
* **'바닥 S + 블로커' 그룹 빌더 (Bottom-Blocker Pair Builder)**
  * **Input**: 전체 도형 데이터.
  * **Logic**: 1층에 **S**, 2층에 **P** 또는 **S**가 있는 기둥을 찾아 2개 조각을 하나의 그룹으로 즉시 확정한다.
  * **Output**: 조각 2개로 구성된 단일 그룹 목록.

**[공용 그룹 이동 엔진 로직 4개 - `_move_s_group`의 내부]**

* **최대 상승 거리 계산기 (Max Rise Calculator)**
  * **Input**: 이동시킬 그룹.
  * **Logic**: 그룹 내 각 기둥의 상단 연속 빈 공간 개수를 세어 그 최솟값을 계산한다.
  * **Output**: 그룹이 상승할 수 있는 최대 거리(정수).
* **최적 위치 탐색기 (Optimal Position Seeker)**
  * **Input**: 그룹, 최대 상승 거리.
  * **Logic**: 최대 상승 위치에서 시작하여, 층을 하나씩 내려가면서 배치 유효성 검사기를 호출한다. 처음으로 성공하는 위치를 찾는다.
  * **Output**: 최종 목표 위치 또는 이동 불가.
* **배치 유효성 검사기 (Placement Validity Checker)**
  * **Input**: 그룹과 테스트할 목표 위치.
  * **Logic**: 목표 위치에 대해 **(1) 충돌 없음, (2) 인접 규칙, (3) 높이 제한 규칙** 3가지를 모두 검사한다.
  * **Output**: 배치 가능 여부 (True/False).
* **그룹 이동 실행 및 후처리기 (Group Move Executor & Post-processor)**
  * **Input**: 이동시킬 그룹, 최종 목표 위치.
  * **Logic**: 그룹의 원본 위치 조각들을 삭제하고 새 위치에 생성한다. 이동 후 'P-S-P' 패턴이 생기면 양 옆의 P를 들어 올린다.
  * **Output**: 변경된 도형 데이터.

**[개별 조각 이동 로직 3개]**

* **미그룹 바닥 S 탐색기 (Ungrouped Bottom S Seeker)**
  * **Input**: 전체 도형 데이터, 이미 처리된 조각 목록.
  * **Logic**: 1층에 있으면서 이전 그룹화에 포함되지 않은 모든 **S** 조각을 찾는다.
  * **Output**: 개별 이동 대상 **S** 조각 목록.
* **개별 S 이동 위치 탐색기 (`_find_s_relocation_spot`)**
  * **Input**: 개별 **S** 조각.
  * **Logic**: 조각 위 하늘이 열렸는지/막혔는지에 따라 탐색 방향(상향/하향)을 결정하고, 유효성 검사를 만족하는 첫 위치를 찾는다.
  * **Output**: 최적의 단일 목표 위치, 함께 이동해야 할 주변 S 정보.
* **가상 이동 공간 확보 로직 (Virtual Shift Space Creator)**
  * **Input**: 개별 **S** 조각과 잠재적 목표 위치.
  * **Logic**: (`_find_s_relocation_spot` 내부) 목표 위치 확보를 위해 옆의 **S**를 위로 한 칸 올리는 가상 이동을 시도하고, 그 결과가 유효한지 판단한다.
  * **Output**: 공간 확보 가능 여부 및 최종 위치.

#### 3단계: 국소적 패턴 반복 조정 (4개 로직)

* **반복 조정 루프 제어기 (Iterative Adjustment Loop Controller)**
  * **Input**: 도형 데이터.
  * **Logic**: 한 번의 전체 스캔에서 조각 이동이 있었는지 여부를 추적하고, 이동이 없을 때까지 3단계 전체를 반복 실행시킨다.
  * **Output**: 안정화된 도형 데이터.
* **조정 대상 P(핀) 탐색기 (Liftable Pin Seeker)**
  * **Input**: 도형 데이터.
  * **Logic**: 1층에 **P**가 있고, 2층이 비어있는 패턴을 찾는다.
  * **Output**: 조정 대상 **P**의 위치 목록.
* **'3방향 막힘' 패턴 리프터 (3-Way Block Lifter)**
  * **Input**: 조정 대상 **P** 위치.
  * **Logic**: 2층 공간의 좌, 우, 위가 모두 막혀있는지 확인하고, 맞다면 양옆 조각(P 또는 S)을 유효한 위치까지 들어 올린다.
  * **Output**: 변경된 도형 데이터 또는 변경 없음.
* **'2방향 막힘+상단 열림' 패턴 리프터 (2-Way Block + Top Open Lifter)**
  * **Input**: 조정 대상 **P** 위치.
  * **Logic**: 2층의 양옆은 막혔지만 3층이 비었는지 확인하고, 맞다면 3층을 기준으로 양옆 조각을 들어 올린다.
  * **Output**: 변경된 도형 데이터 또는 변경 없음.

#### 4단계: c(크리스탈) 채우기 (7개 로직)

* **핀-상향 크리스탈 필러 (Pin-Upwards Crystal Filler)**
  * **Input**: **pins** 리스트, 최종 도형 데이터.
  * **Logic**: 각 **P** 위치에서부터 수직으로 올라가며 다른 조각을 만날 때까지 모든 빈 공간을 **c**로 채운다.
  * **Output**: **c**가 추가된 도형 데이터.
* **반대편 기둥 빌더 (Opposite Pillar Builder)**
  * **Input**: `highest_c_layer` 정보, 최종 도형 데이터.
  * **Logic**: 정반대편 사분면에 위에서 아래로 **c** 기둥을 세우되, 중단 조건(다른 조각, 옆에 원본 c)을 확인한다.
  * **Output**: **c** 기둥이 추가된 도형 데이터.
* **인접 벽 생성기 (c') (Adjacent Wall Builder)**
  * **Input**: 기둥 생성 중인 위치.
  * **Logic**: 기둥 옆 빈 공간에 **c'** 를 배치할지 여부를 '벽 배치 유효성 검사기'를 통해 결정하고 배치한다.
  * **Output**: 벽(**c'**)이 추가된 도형 데이터.
* **벽 배치 유효성 검사기 (Wall Placement Validator)**
  * **Input**: **c'** 를 놓을 후보 위치.
  * **Logic**: 배치 불가 조건(층별 패턴, 주변 c 존재 여부)을 종합적으로 검사하여 배치 가능/불가/예약 상태를 결정한다.
  * **Output**: 유효성 검사 결과 (True/False/Reserved).
* **P-리프트 예외 처리기 (P-Lift Exception Handler)**
  * **Input**: **c'** 후보지 옆 3층에 있는 P.
  * **Logic**: P를 위로 한 칸 올리고 그 자리에 **c'** 를 생성한다. 그 후 S-내리기 후처리를 수행한다.
  * **Output**: P와 **c'** 가 재배치된 도형 데이터.
* **아래-벽 채우기 (c'') (Below-Wall Filler)**
  * **Input**: 새로 생성된 벽(**c'**)들의 좌표.
  * **Logic**: **c'** 조각의 바로 아래 칸이 특정 조건(3층 이상, 비어있음, 원본 c 없음)을 만족하면 그 칸도 **c**로 채운다.
  * **Output**: **c''** 가 추가된 도형 데이터.
* **예약된 'c' 처리기 (Reserved 'c' Handler)**
  * **Input**: '예약' 상태로 판정된 **c'** 후보지 목록.
  * **Logic**: 모든 채우기 종료 후, 예약된 위치를 다시 검토한다. 아래에 **c''** 를 놓을 수 있으면 **c'** 와 **c''** 를 함께 생성한다.
  * **Output**: 최종 **c'**/**c''** 가 추가된 도형 데이터.

#### 5단계: 마무리 (3개 로직)

* **외곽선 c 제거기 (Outline Crystal Remover)**
  * **Input**: '제거 대상 좌표' 목록, 최종 도형 데이터.
  * **Logic**: 목록에 있는 모든 좌표의 **c** 조각을 삭제한다.
  * **Output**: **c**가 정리된 도형 데이터.
* **최하단/최상단 레이어 정리기 (Bottom/Top Layer Trimmer)**
  * **Input**: 최종 도형 데이터.
  * **Logic**: 1층(layer 0) 전체를 버리고, 맨 위부터 비어있는 층들을 모두 삭제한다.
  * **Output**: 최종 형태의 도형 데이터.
* **최종 형태 인코더 (Final Shape Encoder)**
  * **Input**: 정리된 최종 도형 데이터.
  * **Logic**: 도형 구조를 문자열 코드로 변환한다.
  * **Output**: 최종 반환 문자열.
