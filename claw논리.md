## 1단계: 초기 설정 및 정보 수집

프로세스 시작 전, 필요한 정보를 미리 확보하고 준비합니다.

- **정보 추출**

  - '원본 도형'을 분석하여 다음의 핵심 정보를 변수에 저장합니다.
    - **pins**: 1층(가장 아래층)에 위치한 모든 P(핀) 조각의 사분면 번호(0~3).
    - **highest_c_layer**, **c_quad_idx**: 도형 전체에서 가장 높은 층에 있는 단일 c(크리스탈)의 층 번호와 사분면 번호. 이 c는 여러 규칙에서 기준점 역할을 합니다.
- **'외곽선 c' 제거 좌표 수집**

  - 나중에 제거할 크리스탈의 위치를 미리 정의합니다.
    - 기준: 원본 도형에 있는 모든 c(크리스탈) 조각을 찾습니다.
    - 규칙: 찾은 각 c 조각의 물리적으로 인접한 상, 하, 좌, 우 위치를 모두 '제거 대상 좌표' 목록에 추가합니다.
    - 예외: 목록에 포함된 좌표가 다른 '원본 c' 조각의 위치와 겹칠 경우, 해당 좌표는 제거 대상에서 제외됩니다. 이는 원본 c 조각들이 서로 붙어있을 때, 서로를 제거하지 않도록 보호하는 역할을 합니다.

---

## 2단계: S(일반 도형) 조각 재배치

특정 패턴을 만족하는 S 조각들을 그룹으로 묶어, 유효한 위치로 이동시킵니다.

### 2-1. '두 번 뜬 S' 그룹 이동 (최우선)

- **탐색 대상**

  - 3층에 S가 있고, 그 바로 아래인 2층과 바로 위인 4층이 모두 비어있는 기둥을 찾습니다.
- **그룹화 규칙** (**_find_twice_floating_s_group**)

  - 탐색 대상이 된 3층의 S에서 그룹 만들기를 시작합니다.
  - 탐색은 시작점과 그 주변의 매우 제한된 범위(같은 층의 인접 칸, 그 위 칸 등)에서만 이루어집니다.
  - 그룹 확장 조건 1: 현재 그룹에 속한 S와 같은 층에 인접한 다른 S가 있고, 그 다른 S의 바로 위 칸이 비어있다면 그 다른 S도 그룹에 포함시킵니다.
  - 그룹 확장 조건 2 (특별 규칙): 탐색 대상이 된 S의 1층이 빈 공간인 경우, 2층에 있는 S도 그룹에 포함될 수 있습니다.
- **이동 규칙** (**_move_s_group**)

  - 이동 전제 조건: 다음 두 가지 경우에는 그룹을 이동시키지 않습니다.
    1. 그룹에 속하지 않은 인접 S의 바로 아래가 비어있는 경우. (불안정한 구조 방지)
    2. 그룹의 모든 조각들 바로 아래가 이미 비어있는 경우. (불필요한 이동 방지)
  - 최대 상승 거리 계산: 그룹에 속한 각 기둥(사분면)에서 가장 위에 있는 조각을 찾습니다. 그 조각 위로 연속된 빈 공간의 개수를 셉니다. 그룹 전체가 한 번에 올라갈 수 있는 거리는 이 개수들의 최솟값입니다.
  - 최적 위치 탐색 (하강 방식): 계산된 최대 상승 위치에서 시작하여, 그룹 전체를 한 층씩 아래로 내리면서 '유효성 검사'를 수행합니다.
  - '유효성' 판단 기준 (아래 모든 조건을 만족해야 함):
    - 충돌 없음: 그룹의 어떤 조각이라도 이동할 위치에 다른 조각(그룹 외 조각)이 없어야 합니다.
    - 인접 규칙: 그룹 내 S 조각이 이동한 위치의 양 옆에, 그룹에 속하지 않은 S나 c 조각이 하나라도 있으면 안 됩니다.
    - 높이 제한 규칙: **highest_c_layer**(가장 높은 c의 층)의 정반대편 사분면에 있는 가장 높은 조각의 높이가 (**highest_c_layer** - 1)보다 높거나 같으면 안 됩니다. 이는 특정 구역에 조각이 과도하게 쌓이는 것을 방지하는 규칙입니다.
  - **실행**: 최초로 '유효성' 검사를 통과하는 위치가 최종 목적지가 됩니다. 원본 위치의 그룹 조각들을 모두 지우고, 계산된 새 위치에 배치합니다. 만약 바닥에 닿을 때까지 유효한 위치를 찾지 못하면 이동하지 않습니다.

  ### 2-2. '뜬 S' 그룹 이동
- **탐색 대상**: 1층이 비어 있고 2층에 S가 있는 기둥을 찾습니다.
- **그룹화 규칙** (**_find_s_star_group**):

  - 탐색 대상이 된 2층의 S에서 그룹 만들기를 시작합니다.
  - 그룹 확장 조건 A: 현재 그룹 조각과 인접한 S의 바로 위가 비어있으면 그 S를 그룹에 추가합니다.
  - 그룹 확장 조건 B: 현재 그룹 조각과 인접한 S의 위가 다른 S나 P로 막혀있지만, 그 막고 있는 조각의 바로 위가 비어있다면, 인접 S와 그를 막고 있는 조각 둘 다 그룹에 추가합니다.
- **이동 규칙**: 위의 '두 번 뜬 S'와 동일한 **_move_s_group** 규칙을 따릅니다.

  ### 2-3. '바닥 S + 블로커' 그룹 이동
- **탐색 대상**: 1층에 S가 있고, 그 바로 위인 2층에 P(핀) 또는 S가 있는 기둥을 찾습니다.
- **그룹화 규칙**: 1층의 S와 2층의 P 또는 S를 하나의 그룹(조각 2개)으로 묶습니다.
- **이동 규칙**: 위의 '두 번 뜬 S'와 동일한 **_move_s_group** 규칙을 따릅니다.

  ### 2-4. '개별 바닥 S' 이동
- **탐색 대상**: 위 그룹화에 포함되지 않은, 1층에 있는 모든 S 조각.
- **이동 규칙** (**_find_s_relocation_spot**):

  - 각 S에 대해 개별적으로 이동할 최적의 위치를 탐색합니다. 해당 S의 바로 위 하늘이 완전히 열려있는지에 따라 탐색 방식이 달라집니다.
  - 하늘이 열려있을 경우: 3층부터 위로 올라가며 유효한 위치를 찾습니다.
  - 하늘이 막혀있을 경우: 그 기둥을 막고 있는 가장 낮은 조각(천장)의 바로 아래층부터 아래로 내려오며 유효한 위치를 찾습니다.
  - 찾은 빈 공간이 2-1 단계의 '유효성' 판단 기준 중 '인접 규칙'과 '높이 제한 규칙'을 만족하는 첫 번째 위치에 S를 배치합니다. 이 과정에서 옆에 있는 S를 위로 한 칸 올리는 가상 이동을 통해 유효한 공간을 만들기도 합니다.

---

## 3단계: P(핀)와 S(일반 도형) 들어 올리기 (반복 수행)

- **실행 조건**: 이 로직은 더 이상 움직이는 조각이 없을 때까지 계속 반복됩니다.
- **탐색 대상**: 1층에 있는 P(핀) 중, 바로 위(2층) 칸이 비어있는 경우.
- **실행 규칙**:
  - 시나리오 1: 위에서 찾은 2층의 빈 공간을 기준으로, 그 주변 세 방향(좌, 우, 위)이 모두 다른 조각으로 막혀 있는지 확인합니다. 만약 막혀있다면, 그 막고 있는 양옆의 조각(P 또는 S)을 위로 한 칸 들어 올립니다. S의 경우, 유효한 위치를 찾을 때까지 계속 위로 올리기도 합니다.
  - 시나리오 2: 시나리오 1에 해당하지 않고, P 위 2층 공간의 양옆은 막혀있지만 3층 공간이 비어있는 경우, 3층의 빈 공간을 기준으로 다시 주변을 검사하여 양옆 조각을 들어 올립니다.
- **반복**: 이 로직은 한 번의 반복에서 하나라도 조각을 움직였다면, 전체 도형을 대상으로 다시 처음부터 반복 검사를 수행합니다.

---

## 4단계: c(크리스탈) 조각 채우기

모든 S와 P의 이동이 완료된 후, 정해진 규칙에 따라 빈 공간을 c로 채웁니다.

- **핀 위 채우기**: 1단계에서 찾은 모든 P(핀)의 위치에서 수직으로 위쪽을 보며, 연속된 모든 빈 공간을 c로 채웁니다. 다른 조각을 만나면 멈춥니다.
- **반대편 사분면 채우기**: 1단계에서 찾은 **highest_c_layer**의 정반대편 사분면에, 맨 위층부터 아래로 c 기둥을 세웁니다.
  - 중단 조건: 기둥을 세우다가 다른 조각을 만나거나, 또는 빈 공간이지만 그 옆에 '원본 도형'에 있던 c가 존재하면 기둥 세우기를 중단합니다.
- **주변부 확장**: '반대편 사분면 채우기'로 c 기둥을 세우는 동안, 특정 조건(3층 이상, 주변에 기존 c가 없음 등)을 만족하면 기둥 옆의 빈 공간에도 c를 채워 벽처럼 확장합니다. 또한, 이렇게 새로 생긴 c의 바로 아래가 비어있고, 그 위치가 3층 이상이며 원본 도형에 c가 없었다면 그 공간도 c로 메웁니다.

---

## 5단계: 마무리 및 최종 반환

- **'외곽선 c' 제거**: 1단계에서 수집해 둔 '제거 대상 좌표' 목록에 해당하는 위치의 c 조각들을 모두 제거합니다. 이 단계는 원본 c 주변을 정리하는 효과를 줍니다.
- **1층 제거**: 변형이 완료된 작업 도형에서 1층(layer 0)을 통째로 버립니다.
- **빈 층 정리**: 도형의 맨 위부터 비어있는 층이 있다면 모두 삭제합니다.
- **최종 반환**: 완성된 도형의 구조를 다시 문자열 코드로 변환하여 반환합니다.
